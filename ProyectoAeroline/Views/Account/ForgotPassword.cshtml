@model ProyectoAeroline.Models.ForgotPasswordViewModel
@{
    ViewData["Title"] = "Recuperar contraseña";
    Layout = "~/Views/Shared/_AuthLayout.cshtml";
}

<link rel="stylesheet" href="~/css/login.modern.css" asp-append-version="true" />

<div class="auth-shell">
    <div class="lg2-wrap">

        <aside class="lg2-left">
            <div class="frame-wrap" id="frameWrap" style="--fit:0.76; --stage-max:clamp(560px,48vw,760px);">
                <img id="frame-seq" src="~/img/frames/1.png" alt="frame animation" />
            </div>
        </aside>

        <main class="lg2-right">
            <section class="lg2-card lg2-card-forgot">
                <div class="lg2-icon-wrapper">
                    <div class="lg2-icon-circle">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                            <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                        </svg>
                    </div>
                </div>
                
                <h1 class="lg2-title">Recuperar contraseña</h1>
                <p class="lg2-sub">No se preocupe, le ayudaremos a restablecer su contraseña</p>

                @if (TempData["Info"] is string info && !string.IsNullOrWhiteSpace(info))
                {
                    <div class="lg2-alert lg2-alert-success" role="alert">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px; vertical-align: middle;">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                            <polyline points="22 4 12 14.01 9 11.01"></polyline>
                        </svg>
                        @info
                    </div>
                }

                <form id="forgotPasswordForm" asp-controller="Account" asp-action="ForgotPassword" method="post">
                    @Html.AntiForgeryToken()

                    <div asp-validation-summary="ModelOnly" class="lg2-alert" role="alert"></div>

                    <div class="lg2-info-box">
                        <div class="lg2-info-icon">📧</div>
                        <div class="lg2-info-text">
                            <strong>Instrucciones</strong>
                            <p>Ingrese su dirección de correo electrónico asociada a su cuenta. Le enviaremos un enlace seguro para restablecer su contraseña.</p>
                        </div>
                    </div>

                    <div class="lg2-field">
                        <label for="Correo">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px; vertical-align: middle;">
                                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                                <polyline points="22,6 12,13 2,6"></polyline>
                            </svg>
                            Correo electrónico
                        </label>
                        <input asp-for="Correo" id="Correo" type="email" autocomplete="email" placeholder="nombre@ejemplo.com" required />
                        <span class="lg2-underline"></span>
                        <span asp-validation-for="Correo" class="field-error"></span>
                    </div>

                    <button type="submit" class="lg2-btn lg2-btn-primary lg2-btn-submit">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px;">
                            <line x1="22" y1="2" x2="11" y2="13"></line>
                            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                        </svg>
                        Enviar enlace de recuperación
                    </button>
                </form>

                <div class="lg2-separator">
                    <span>o</span>
                </div>

                <p class="lg2-help-text">
                    ¿Recordó su contraseña?
                    <a asp-controller="Account" asp-action="Login" class="lg2-link">Volver al inicio de sesión</a>
                </p>

                <div class="lg2-security-note">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                    </svg>
                    <span>Su información está protegida con encriptación de nivel empresarial</span>
                </div>
            </section>
        </main>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        (() => {
          const img = document.getElementById("frame-seq");
          const wrap = document.getElementById("frameWrap");
          const email = document.getElementById("Correo");
          const form = document.getElementById("forgotPasswordForm");
          if (!img) return;

          const PATH = "/img/frames/";
          const FPS_IDLE = 8, FPS_FOCUS = 10, FPS_ERROR = 10;
          const IDLE_MIN = 1, IDLE_MAX = 7;
          const FOC_MIN = 56, FOC_MAX = 97;
          const ERR_MIN = 36, ERR_MAX = 56;

          let loopTimer = null, frames = [], idx = 0, currentMode = "idle", isOneShot = false;

          const setAspectFromImage = (el) => {
            const w = el.naturalWidth || el.width, h = el.naturalHeight || el.height;
            if (wrap && w && h) wrap.style.setProperty('--ar', `${w} / ${h}`);
          };
          const pingPong = (min, max) => {
            const seq = [];
            for (let i = min; i <= max; i++) seq.push(i);
            for (let i = max - 1; i >= min + 1; i--) seq.push(i);
            return seq;
          };
          const preload = (arr) => arr.forEach(n => { const p = new Image(); p.src = `${PATH}${n}.png`; });

          const stopLoop = () => { if (loopTimer) { clearInterval(loopTimer); loopTimer = null; } };
          const startLoop = (newFrames, fps, mode) => {
            if (isOneShot) return;
            if (currentMode === mode && loopTimer) return;
            currentMode = mode; stopLoop(); frames = newFrames.slice(); idx = 0;
            img.addEventListener('load', function onFirstLoad() {
              setAspectFromImage(img); img.removeEventListener('load', onFirstLoad);
            }, { once: true });
            img.src = `${PATH}${frames[idx]}.png`;
            loopTimer = setInterval(() => {
              idx = (idx + 1) % frames.length;
              img.src = `${PATH}${frames[idx]}.png`;
            }, 1000 / fps);
          };

          const idleSeq = pingPong(IDLE_MIN, IDLE_MAX);
          const focusSeq = pingPong(FOC_MIN, FOC_MAX);
          preload(idleSeq); preload(focusSeq);
          startLoop(idleSeq, FPS_IDLE, "idle");

          const onFocus = () => { if (!isOneShot) startLoop(focusSeq, FPS_FOCUS, "focus"); };
          const onBlur = () => setTimeout(() => {
            if (!email.matches(":focus"))
              startLoop(idleSeq, FPS_IDLE, "idle");
          }, 100);
          email?.addEventListener('focus', onFocus);
          email?.addEventListener('blur', onBlur);

          // === Error animation ===
          function playErrorOneShot() {
            if (isOneShot) return;
            isOneShot = true;
            stopLoop();
            const seq = [];
            for (let i = ERR_MAX; i >= ERR_MIN; i--) seq.push(i);
            for (let i = ERR_MIN + 1; i <= ERR_MAX; i++) seq.push(i);
            preload(seq);
            let k = 0; img.src = `${PATH}${seq[k]}.png`;
            const t = setInterval(() => {
              k++;
              if (k >= seq.length) {
                clearInterval(t); isOneShot = false;
                if (email.matches(":focus"))
                  startLoop(focusSeq, FPS_FOCUS, "focus");
                else startLoop(idleSeq, FPS_IDLE, "idle");
                return;
              }
              img.src = `${PATH}${seq[k]}.png`;
            }, 1000 / FPS_ERROR);
          }

          email?.addEventListener('invalid', () => playErrorOneShot(), true);
          form?.addEventListener('submit', (e) => {
            if (!form.checkValidity()) { e.preventDefault(); playErrorOneShot(); }
          });
        })();
    </script>
}
