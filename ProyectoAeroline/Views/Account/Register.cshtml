@model ProyectoAeroline.Models.RegisterViewModel
@{
    ViewData["Title"] = "Registro";
    Layout = "~/Views/Shared/_AuthLayout.cshtml";
}

<link rel="stylesheet" href="~/css/login.modern.css" asp-append-version="true" />

<div class="auth-shell">
    <div class="lg2-wrap">

        <aside class="lg2-left">
            <div class="frame-wrap" id="frameWrap" style="--fit:0.76; --stage-max:clamp(560px,48vw,760px);">
                <img id="frame-seq" src="~/img/frames/1.png" alt="frame animation" />
            </div>
        </aside>

        <main class="lg2-right">
            <section class="lg2-card lg2-card-register">
                <div class="lg2-icon-wrapper">
                    <div class="lg2-icon-circle lg2-icon-circle-register">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg>
                    </div>
                </div>
                
                <h1 class="lg2-title">Crear cuenta</h1>
                <p class="lg2-sub">Completa el formulario para comenzar</p>

                <form id="registerForm" asp-controller="Account" asp-action="Register" method="post">
                    @Html.AntiForgeryToken()

                    <div asp-validation-summary="ModelOnly" class="lg2-alert" role="alert"></div>

                    <div class="lg2-info-box">
                        <div class="lg2-info-icon">✉️</div>
                        <div class="lg2-info-text">
                            <strong>Información importante</strong>
                            <p>La contraseña debe tener un mínimo de 6 caracteres. Asegúrate de elegir una contraseña segura.</p>
                        </div>
                    </div>

                    <div class="lg2-field">
                        <label for="Nombre">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px; vertical-align: middle;">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                <circle cx="12" cy="7" r="4"></circle>
                            </svg>
                            Nombre completo
                        </label>
                        <input asp-for="Nombre" id="Nombre" type="text" autocomplete="name" placeholder="Ingrese su nombre" required />
                        <span class="lg2-underline"></span>
                        <span asp-validation-for="Nombre" class="field-error"></span>
                    </div>

                    <div class="lg2-field">
                        <label for="Correo">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px; vertical-align: middle;">
                                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                                <polyline points="22,6 12,13 2,6"></polyline>
                            </svg>
                            Correo electrónico
                        </label>
                        <input asp-for="Correo" id="Correo" type="email" autocomplete="email" placeholder="nombre@ejemplo.com" required />
                        <span class="lg2-underline"></span>
                        <span asp-validation-for="Correo" class="field-error"></span>
                    </div>

                    <div class="lg2-field">
                        <label for="Password">Contraseña</label>
                        <input asp-for="Password" id="Password" type="password" autocomplete="new-password" placeholder="Mínimo 6 caracteres" required minlength="6" />
                        <button type="button" id="btnTogglePwd1" class="lg2-eye">👁️</button>
                        <span class="lg2-underline"></span>
                        <span asp-validation-for="Password" class="field-error"></span>
                    </div>

                    <div class="lg2-field">
                        <label for="ConfirmPassword">Confirmar contraseña</label>
                        <input asp-for="ConfirmPassword" id="ConfirmPassword" type="password" autocomplete="new-password" placeholder="Repita su contraseña" required minlength="6" />
                        <button type="button" id="btnTogglePwd2" class="lg2-eye">👁️</button>
                        <span class="lg2-underline"></span>
                        <span asp-validation-for="ConfirmPassword" class="field-error"></span>
                    </div>

                    <button type="submit" class="lg2-btn lg2-btn-primary lg2-btn-submit">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px;">
                            <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg>
                        Crear cuenta
                    </button>
                </form>

                <div class="lg2-separator">
                    <span>o</span>
                </div>

                <p class="lg2-help-text">
                    ¿Ya tienes cuenta?
                    <a asp-controller="Account" asp-action="Login" class="lg2-link">Inicia sesión</a>
                </p>

                <div class="lg2-security-note">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                    </svg>
                    <span>Sus datos están protegidos con encriptación de nivel empresarial</span>
                </div>
            </section>
        </main>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        (() => {
          const img = document.getElementById("frame-seq");
          const wrap = document.getElementById("frameWrap");
          const nombre = document.getElementById("Nombre");
          const correo = document.getElementById("Correo");
          const pwd1 = document.getElementById("Password");
          const pwd2 = document.getElementById("ConfirmPassword");
          const form = document.getElementById("registerForm");
          const btnEye1 = document.getElementById("btnTogglePwd1");
          const btnEye2 = document.getElementById("btnTogglePwd2");
          if (!img) return;

          const PATH = "/img/frames/";
          const FPS_IDLE = 8, FPS_FOCUS = 10, FPS_ERROR = 10, FPS_EYE = 10;
          const IDLE_MIN = 1, IDLE_MAX = 7;
          const FOC_MIN = 56, FOC_MAX = 97;
          const ERR_MIN = 36, ERR_MAX = 56;
          const EYE_OPEN_MIN = 15, EYE_OPEN_MAX = 25, EYE_TURN_MAX = 35;

          let loopTimer = null, frames = [], idx = 0, currentMode = "idle", isOneShot = false;
          const anim = { id: null, token: 0 };
          let eyeBusy = false;

          const setAspectFromImage = (el) => {
            const w = el.naturalWidth || el.width, h = el.naturalHeight || el.height;
            if (wrap && w && h) wrap.style.setProperty('--ar', `${w} / ${h}`);
          };
          const pingPong = (min, max) => {
            const seq = [];
            for (let i = min; i <= max; i++) seq.push(i);
            for (let i = max - 1; i >= min + 1; i--) seq.push(i);
            return seq;
          };
          const preload = (arr) => arr.forEach(n => { const p = new Image(); p.src = `${PATH}${n}.png`; });

          const stopLoop = () => { if (loopTimer) { clearInterval(loopTimer); loopTimer = null; } };
          const startLoop = (newFrames, fps, mode) => {
            if (eyeBusy) return;
            if (isOneShot || anim.id) return;
            if (currentMode === mode && loopTimer) return;
            currentMode = mode; stopLoop(); frames = newFrames.slice(); idx = 0;
            img.addEventListener('load', function onFirstLoad() {
              setAspectFromImage(img); img.removeEventListener('load', onFirstLoad);
            }, { once: true });
            img.src = `${PATH}${frames[idx]}.png`;
            loopTimer = setInterval(() => {
              idx = (idx + 1) % frames.length;
              img.src = `${PATH}${frames[idx]}.png`;
            }, 1000 / fps);
          };

          const idleSeq = pingPong(IDLE_MIN, IDLE_MAX);
          const focusSeq = pingPong(FOC_MIN, FOC_MAX);
          preload(idleSeq); preload(focusSeq);
          startLoop(idleSeq, FPS_IDLE, "idle");

          const onFocus = () => { if (!eyeBusy) startLoop(focusSeq, FPS_FOCUS, "focus"); };
          const onBlur = () => setTimeout(() => {
            if (eyeBusy) return;
            if (!nombre.matches(":focus") && !correo.matches(":focus") && !pwd1.matches(":focus") && !pwd2.matches(":focus"))
              startLoop(idleSeq, FPS_IDLE, "idle");
          }, 100);
          nombre?.addEventListener('focus', onFocus);
          correo?.addEventListener('focus', onFocus);
          pwd1?.addEventListener('focus', onFocus);
          pwd2?.addEventListener('focus', onFocus);
          nombre?.addEventListener('blur', onBlur);
          correo?.addEventListener('blur', onBlur);
          pwd1?.addEventListener('blur', onBlur);
          pwd2?.addEventListener('blur', onBlur);

          // === Controlador de animación del ojo ===
          const sleep = (ms) => new Promise(r => setTimeout(r, ms));
          const stopAnim = () => { if (anim.id) clearInterval(anim.id); anim.id = null; anim.token++; };
          const currentFrame = () => parseInt(img.src.match(/(\d+)\.png$/)?.[1] || 16);

          async function playFrames(seq, fps) {
            const my = ++anim.token;
            stopLoop();
            for (let f of seq) {
              if (my !== anim.token) return;
              img.src = `${PATH}${f}.png`;
              await sleep(1000 / fps);
            }
          }
          function startPingPong(min, max, fps) {
            stopAnim();
            const my = ++anim.token;
            const seq = pingPong(min, max);
            let k = 0; img.src = `${PATH}${seq[k]}.png`;
            anim.id = setInterval(() => {
              if (my !== anim.token) { clearInterval(anim.id); return; }
              k = (k + 1) % seq.length;
              img.src = `${PATH}${seq[k]}.png`;
            }, 1000 / fps);
          }
          const resumeLoop = () => {
            stopAnim();
            if (nombre.matches(":focus") || correo.matches(":focus") || pwd1.matches(":focus") || pwd2.matches(":focus"))
              startLoop(focusSeq, FPS_FOCUS, "focus");
            else startLoop(idleSeq, FPS_IDLE, "idle");
          };

          // Toggle password visibility para el primer campo
          if (btnEye1 && pwd1) {
            btnEye1.addEventListener("click", async () => {
              const willShow = pwd1.type === "password";
              pwd1.type = willShow ? "text" : "password";
              btnEye1.textContent = willShow ? "🙈" : "👁️";

              if (willShow) {
                eyeBusy = true;
                const seq = [];
                for (let i = EYE_TURN_MAX; i >= EYE_OPEN_MIN; i--) seq.push(i);
                await playFrames(seq, FPS_EYE);
                startPingPong(EYE_OPEN_MIN, EYE_OPEN_MAX, FPS_EYE);
              } else {
                const start = Math.max(currentFrame(), EYE_OPEN_MIN);
                const seq = [];
                for (let i = start; i <= EYE_TURN_MAX; i++) seq.push(i);
                await playFrames(seq, FPS_EYE);
                eyeBusy = false;
                resumeLoop();
              }
            });
          }

          // Toggle password visibility para el segundo campo
          if (btnEye2 && pwd2) {
            btnEye2.addEventListener("click", async () => {
              const willShow = pwd2.type === "password";
              pwd2.type = willShow ? "text" : "password";
              btnEye2.textContent = willShow ? "🙈" : "👁️";

              if (willShow) {
                eyeBusy = true;
                const seq = [];
                for (let i = EYE_TURN_MAX; i >= EYE_OPEN_MIN; i--) seq.push(i);
                await playFrames(seq, FPS_EYE);
                startPingPong(EYE_OPEN_MIN, EYE_OPEN_MAX, FPS_EYE);
              } else {
                const start = Math.max(currentFrame(), EYE_OPEN_MIN);
                const seq = [];
                for (let i = start; i <= EYE_TURN_MAX; i++) seq.push(i);
                await playFrames(seq, FPS_EYE);
                eyeBusy = false;
                resumeLoop();
              }
            });
          }

          // === Error animation ===
          function playErrorOneShot() {
            if (eyeBusy) return;
            if (isOneShot) return;
            isOneShot = true;
            stopLoop();
            stopAnim();
            const seq = [];
            for (let i = ERR_MAX; i >= ERR_MIN; i--) seq.push(i);
            for (let i = ERR_MIN + 1; i <= ERR_MAX; i++) seq.push(i);
            preload(seq);
            let k = 0; img.src = `${PATH}${seq[k]}.png`;
            const t = setInterval(() => {
              k++;
              if (k >= seq.length) {
                clearInterval(t); isOneShot = false;
                resumeLoop();
                return;
              }
              img.src = `${PATH}${seq[k]}.png`;
            }, 1000 / FPS_ERROR);
          }

          [nombre, correo, pwd1, pwd2].forEach(el => el?.addEventListener('invalid', () => playErrorOneShot(), true));
          form?.addEventListener('submit', (e) => {
            if (!form.checkValidity()) { e.preventDefault(); playErrorOneShot(); }
          });
        })();
    </script>
}
