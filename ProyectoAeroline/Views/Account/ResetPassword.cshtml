@model ProyectoAeroline.Models.ResetPasswordViewModel
@{
    ViewData["Title"] = "Restablecer contraseña";
    Layout = "~/Views/Shared/_AuthLayout.cshtml";
    
    // Obtener el token de la query string
    var tokenFromQuery = Context.Request.Query["token"].ToString();
    if (!string.IsNullOrEmpty(tokenFromQuery))
    {
        Model.Token = tokenFromQuery;
    }
}

<link rel="stylesheet" href="~/css/login.modern.css" asp-append-version="true" />

<div class="auth-shell">
    <div class="lg2-wrap">

        <aside class="lg2-left">
            <div class="frame-wrap" id="frameWrap" style="--fit:0.76; --stage-max:clamp(560px,48vw,760px);">
                <img id="frame-seq" src="~/img/frames/1.png" alt="frame animation" />
            </div>
        </aside>

        <main class="lg2-right">
            <section class="lg2-card">
                <div class="lg2-badge">🔑</div>
                <h1 class="lg2-title">Restablecer contraseña</h1>
                <p class="lg2-sub">Ingrese su nueva contraseña</p>

                @if (TempData["Info"] is string info && !string.IsNullOrWhiteSpace(info))
                {
                    <div class="lg2-alert lg2-alert-success" role="alert">@info</div>
                }

                @if (ViewBag.Message is string message && !string.IsNullOrWhiteSpace(message))
                {
                    <div class="lg2-alert lg2-alert-info" role="alert" style="background-color: #e3f2fd; color: #1976d2; border: 1px solid #90caf9;">
                        @message
                    </div>
                }

                <form id="resetPasswordForm" asp-controller="Account" asp-action="ResetPassword" method="post">
                    @Html.AntiForgeryToken()

                    <div asp-validation-summary="ModelOnly" class="lg2-alert" role="alert"></div>

                    <!-- El token llega por querystring y lo pasamos hidden -->
                    <input type="hidden" asp-for="Token" />
                    <!-- Pasar el parámetro fromGoogle si viene de Google -->
                    @if (ViewBag.FromGoogle == true)
                    {
                        <input type="hidden" name="fromGoogle" value="true" />
                    }

                    <div class="lg2-field">
                        <label for="NuevaPassword">Nueva contraseña</label>
                        <input asp-for="NuevaPassword" id="NuevaPassword" type="password" autocomplete="new-password" required minlength="6" />
                        <button type="button" id="btnTogglePwd1" class="lg2-eye">👁️</button>
                        <span class="lg2-underline"></span>
                        <span asp-validation-for="NuevaPassword" class="field-error"></span>
                    </div>

                    <div class="lg2-field">
                        <label for="Confirmacion">Confirmar contraseña</label>
                        <input asp-for="Confirmacion" id="Confirmacion" type="password" autocomplete="new-password" required minlength="6" />
                        <button type="button" id="btnTogglePwd2" class="lg2-eye">👁️</button>
                        <span class="lg2-underline"></span>
                        <span asp-validation-for="Confirmacion" class="field-error"></span>
                    </div>

                    <button type="submit" class="lg2-btn lg2-btn-primary">Cambiar contraseña</button>
                </form>

                <p style="text-align:center; margin-top:18px; color:#7b8190;">
                    ¿Recordó su contraseña?
                    <a asp-controller="Account" asp-action="Login" class="lg2-link">Volver al inicio de sesión</a>
                </p>
            </section>
        </main>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        (() => {
          const img = document.getElementById("frame-seq");
          const wrap = document.getElementById("frameWrap");
          const pwd1 = document.getElementById("NuevaPassword");
          const pwd2 = document.getElementById("Confirmacion");
          const form = document.getElementById("resetPasswordForm");
          const btnEye1 = document.getElementById("btnTogglePwd1");
          const btnEye2 = document.getElementById("btnTogglePwd2");
          if (!img) return;

          const PATH = "/img/frames/";
          const FPS_IDLE = 8, FPS_FOCUS = 10, FPS_ERROR = 10, FPS_EYE = 10;
          const IDLE_MIN = 1, IDLE_MAX = 7;
          const FOC_MIN = 56, FOC_MAX = 97;
          const ERR_MIN = 36, ERR_MAX = 56;
          const EYE_OPEN_MIN = 15, EYE_OPEN_MAX = 25, EYE_TURN_MAX = 35;

          let loopTimer = null, frames = [], idx = 0, currentMode = "idle", isOneShot = false;
          const anim = { id: null, token: 0 };
          let eyeBusy = false;

          const setAspectFromImage = (el) => {
            const w = el.naturalWidth || el.width, h = el.naturalHeight || el.height;
            if (wrap && w && h) wrap.style.setProperty('--ar', `${w} / ${h}`);
          };
          const pingPong = (min, max) => {
            const seq = [];
            for (let i = min; i <= max; i++) seq.push(i);
            for (let i = max - 1; i >= min + 1; i--) seq.push(i);
            return seq;
          };
          const preload = (arr) => arr.forEach(n => { const p = new Image(); p.src = `${PATH}${n}.png`; });

          const stopLoop = () => { if (loopTimer) { clearInterval(loopTimer); loopTimer = null; } };
          const startLoop = (newFrames, fps, mode) => {
            if (eyeBusy) return;
            if (isOneShot || anim.id) return;
            if (currentMode === mode && loopTimer) return;
            currentMode = mode; stopLoop(); frames = newFrames.slice(); idx = 0;
            img.addEventListener('load', function onFirstLoad() {
              setAspectFromImage(img); img.removeEventListener('load', onFirstLoad);
            }, { once: true });
            img.src = `${PATH}${frames[idx]}.png`;
            loopTimer = setInterval(() => {
              idx = (idx + 1) % frames.length;
              img.src = `${PATH}${frames[idx]}.png`;
            }, 1000 / fps);
          };

          const idleSeq = pingPong(IDLE_MIN, IDLE_MAX);
          const focusSeq = pingPong(FOC_MIN, FOC_MAX);
          preload(idleSeq); preload(focusSeq);
          startLoop(idleSeq, FPS_IDLE, "idle");

          const onFocus = () => { if (!eyeBusy) startLoop(focusSeq, FPS_FOCUS, "focus"); };
          const onBlur = () => setTimeout(() => {
            if (eyeBusy) return;
            if (!pwd1.matches(":focus") && !pwd2.matches(":focus"))
              startLoop(idleSeq, FPS_IDLE, "idle");
          }, 100);
          pwd1?.addEventListener('focus', onFocus);
          pwd2?.addEventListener('focus', onFocus);
          pwd1?.addEventListener('blur', onBlur);
          pwd2?.addEventListener('blur', onBlur);

          // === Controlador de animación del ojo ===
          const sleep = (ms) => new Promise(r => setTimeout(r, ms));
          const stopAnim = () => { if (anim.id) clearInterval(anim.id); anim.id = null; anim.token++; };
          const currentFrame = () => parseInt(img.src.match(/(\d+)\.png$/)?.[1] || 16);

          async function playFrames(seq, fps) {
            const my = ++anim.token;
            stopLoop();
            for (let f of seq) {
              if (my !== anim.token) return;
              img.src = `${PATH}${f}.png`;
              await sleep(1000 / fps);
            }
          }
          function startPingPong(min, max, fps) {
            stopAnim();
            const my = ++anim.token;
            const seq = pingPong(min, max);
            let k = 0; img.src = `${PATH}${seq[k]}.png`;
            anim.id = setInterval(() => {
              if (my !== anim.token) { clearInterval(anim.id); return; }
              k = (k + 1) % seq.length;
              img.src = `${PATH}${seq[k]}.png`;
            }, 1000 / fps);
          }
          const resumeLoop = () => {
            stopAnim();
            if (pwd1.matches(":focus") || pwd2.matches(":focus"))
              startLoop(focusSeq, FPS_FOCUS, "focus");
            else startLoop(idleSeq, FPS_IDLE, "idle");
          };

          // Toggle password visibility para el primer campo
          if (btnEye1 && pwd1) {
            btnEye1.addEventListener("click", async () => {
              const willShow = pwd1.type === "password";
              pwd1.type = willShow ? "text" : "password";
              btnEye1.textContent = willShow ? "🙈" : "👁️";

              if (willShow) {
                eyeBusy = true;
                const seq = [];
                for (let i = EYE_TURN_MAX; i >= EYE_OPEN_MIN; i--) seq.push(i);
                await playFrames(seq, FPS_EYE);
                startPingPong(EYE_OPEN_MIN, EYE_OPEN_MAX, FPS_EYE);
              } else {
                const start = Math.max(currentFrame(), EYE_OPEN_MIN);
                const seq = [];
                for (let i = start; i <= EYE_TURN_MAX; i++) seq.push(i);
                await playFrames(seq, FPS_EYE);
                eyeBusy = false;
                resumeLoop();
              }
            });
          }

          // Toggle password visibility para el segundo campo
          if (btnEye2 && pwd2) {
            btnEye2.addEventListener("click", async () => {
              const willShow = pwd2.type === "password";
              pwd2.type = willShow ? "text" : "password";
              btnEye2.textContent = willShow ? "🙈" : "👁️";

              if (willShow) {
                eyeBusy = true;
                const seq = [];
                for (let i = EYE_TURN_MAX; i >= EYE_OPEN_MIN; i--) seq.push(i);
                await playFrames(seq, FPS_EYE);
                startPingPong(EYE_OPEN_MIN, EYE_OPEN_MAX, FPS_EYE);
              } else {
                const start = Math.max(currentFrame(), EYE_OPEN_MIN);
                const seq = [];
                for (let i = start; i <= EYE_TURN_MAX; i++) seq.push(i);
                await playFrames(seq, FPS_EYE);
                eyeBusy = false;
                resumeLoop();
              }
            });
          }

          // === Error animation ===
          function playErrorOneShot() {
            if (eyeBusy) return;
            if (isOneShot) return;
            isOneShot = true;
            stopLoop();
            stopAnim();
            const seq = [];
            for (let i = ERR_MAX; i >= ERR_MIN; i--) seq.push(i);
            for (let i = ERR_MIN + 1; i <= ERR_MAX; i++) seq.push(i);
            preload(seq);
            let k = 0; img.src = `${PATH}${seq[k]}.png`;
            const t = setInterval(() => {
              k++;
              if (k >= seq.length) {
                clearInterval(t); isOneShot = false;
                resumeLoop();
                return;
              }
              img.src = `${PATH}${seq[k]}.png`;
            }, 1000 / FPS_ERROR);
          }

          [pwd1, pwd2].forEach(el => el?.addEventListener('invalid', () => playErrorOneShot(), true));
          form?.addEventListener('submit', (e) => {
            if (!form.checkValidity()) { e.preventDefault(); playErrorOneShot(); }
          });
        })();
    </script>
}
