@* Pages/Shared/_Sidebar.cshtml *@
@using System.Security.Claims
@using ProyectoAeroline.Helpers
@inject ProyectoAeroline.Services.IPermisosService PermisosService
@{
    // Muestra el nombre del usuario priorizando Claims; luego Session; luego Identity.Name
    var nombre =
        User.FindFirst(ClaimTypes.Name)?.Value
        ?? User.FindFirst("Nombre")?.Value
        ?? Context.Session?.GetString("Nombre")
        ?? User.Identity?.Name
        ?? "Usuario";

    // ⬇️ ID del usuario actual para armar la ruta a Usuarios/Modificar
    var idUsuario =
        User.FindFirst(ClaimTypes.NameIdentifier)?.Value
        ?? Context.Session?.GetInt32("IdUsuario")?.ToString();

    // Obtiene la ruta actual para marcar el enlace activo
    var path = Context.Request.Path.Value ?? "";
    bool isHome = path.Equals("/", StringComparison.OrdinalIgnoreCase) || path.StartsWith("/Index", StringComparison.OrdinalIgnoreCase);
    bool isEmpleados = path.StartsWith("/Empleados", StringComparison.OrdinalIgnoreCase);
    bool isUsuarios = path.StartsWith("/Usuarios", StringComparison.OrdinalIgnoreCase);
    bool isRoles = path.StartsWith("/Roles", StringComparison.OrdinalIgnoreCase);
    bool isPantallas = path.StartsWith("/Pantallas", StringComparison.OrdinalIgnoreCase);
    bool isAeropuertos = path.StartsWith("/Aeropuertos", StringComparison.OrdinalIgnoreCase);
    bool isAviones = path.StartsWith("/Aviones", StringComparison.OrdinalIgnoreCase);
    bool isMantenimientos = path.StartsWith("/Mantenimientos", StringComparison.OrdinalIgnoreCase);
    bool isAerolineas = path.StartsWith("/Aerolineas", StringComparison.OrdinalIgnoreCase);
    bool isVuelos = path.StartsWith("/Vuelos", StringComparison.OrdinalIgnoreCase);
    bool isHorarios = path.StartsWith("/Horarios", StringComparison.OrdinalIgnoreCase);
    bool isEscalas = path.StartsWith("/Escalas", StringComparison.OrdinalIgnoreCase);
    bool isPasajeros = path.StartsWith("/Pasajeros", StringComparison.OrdinalIgnoreCase);
    bool isBoletos = path.StartsWith("/Boletos", StringComparison.OrdinalIgnoreCase);
    bool isRolPantallaOpcion = path.StartsWith("/RolPantallaOpcion", StringComparison.OrdinalIgnoreCase);
    bool isEquipaje = path.StartsWith("/Equipaje", StringComparison.OrdinalIgnoreCase);
    bool isServicios = path.StartsWith("/Servicios", StringComparison.OrdinalIgnoreCase);
    bool isReservas = path.StartsWith("/Reservas", StringComparison.OrdinalIgnoreCase);
    bool isFacturacion = path.StartsWith("/Facturacion", StringComparison.OrdinalIgnoreCase);
    bool isHistoriales = path.StartsWith("/Historiales", StringComparison.OrdinalIgnoreCase);
    
    // Helper para verificar permisos en Razor Pages
    bool PuedeVer(string nombrePantalla)
    {
        if (User?.Identity?.IsAuthenticated != true)
            return false;
        return PermisosService.TienePermiso(User, nombrePantalla, "Ver");
    }
}

<aside id="sidebar" class="sb-sidebar text-bg-dark">
    <div class="sb-brand px-3 py-3 d-flex align-items-center">
        <i class="bi bi-bootstrap-fill fs-4 me-2"></i>
        <span class="sb-brand-text">Aerolinea</span>
    </div>

    <hr class="m-0 opacity-25" />

    <nav class="sb-nav py-3">
        <!-- Home siempre visible -->
        <a class="sb-link @(isHome ? "active" : "")" asp-page="/Index">
            <i class="bi bi-house"></i><span>Home</span>
        </a>

        @if (PuedeVer("Empleados"))
        {
            <a class="sb-link @(isEmpleados ? "active" : "")" asp-controller="Empleados" asp-action="Listar">
                <i class="bi bi-speedometer2"></i><span>Empleados</span>
            </a>
        }

        @if (PuedeVer("Usuarios"))
        {
            <a class="sb-link @(isUsuarios ? "active" : "")" asp-controller="Usuarios" asp-action="Listar">
                <i class="bi bi-receipt"></i><span>Usuarios</span>
            </a>
        }

        @if (PuedeVer("Roles"))
        {
            <a class="sb-link @(isRoles ? "active" : "")" asp-controller="Roles" asp-action="Listar">
                <i class="bi bi-shield-check"></i><span>Roles</span>
            </a>
        }

        @if (PuedeVer("Pantallas"))
        {
            <a class="sb-link @(isPantallas ? "active" : "")" asp-controller="Pantallas" asp-action="Listar">
                <i class="bi bi-window"></i><span>Pantallas</span>
            </a>
        }

        @if (PuedeVer("RolPantallaOpcion"))
        {
            <a class="sb-link @(isRolPantallaOpcion ? "active" : "")" asp-controller="RolPantallaOpcion" asp-action="Listar">
                <i class="bi bi-key-fill"></i><span>Permisos</span>
            </a>
        }

        @if (PuedeVer("Aeropuertos"))
        {
            <a class="sb-link @(isAeropuertos ? "active" : "")" asp-controller="Aeropuertos" asp-action="Listar">
                <i class="bi bi-box-seam"></i><span>Aeropuertos</span>
            </a>
        }

        @if (PuedeVer("Aviones"))
        {
            <a class="sb-link @(isAviones ? "active" : "")" asp-controller="Aviones" asp-action="Listar">
                <i class="bi bi-people"></i><span>Aviones</span>
            </a>
        }

        @if (PuedeVer("Mantenimientos"))
        {
            <a class="sb-link @(isMantenimientos ? "active" : "")" asp-controller="Mantenimientos" asp-action="Listar">
                <i class="bi bi-tools"></i><span>Mantenimientos</span>
            </a>
        }

        @if (PuedeVer("Aerolineas"))
        {
            <a class="sb-link @(isAerolineas ? "active" : "")" asp-controller="Aerolineas" asp-action="Listar">
                <i class="bi bi-airplane"></i><span>Aerolineas</span>
            </a>
        }

        @if (PuedeVer("Vuelos"))
        {
            <a class="sb-link @(isVuelos ? "active" : "")" asp-controller="Vuelos" asp-action="Listar">
                <i class="bi bi-airplane-fill"></i><span>Vuelos</span>
            </a>
        }

        @if (PuedeVer("Horarios"))
        {
            <a class="sb-link @(isHorarios ? "active" : "")" asp-controller="Horarios" asp-action="Listar">
                <i class="bi bi-clock"></i><span>Horarios</span>
            </a>
        }

        @if (PuedeVer("Escalas"))
        {
            <a class="sb-link @(isEscalas ? "active" : "")" asp-controller="Escalas" asp-action="Listar">
                <i class="bi bi-airplane-engines"></i><span>Escalas</span>
            </a>
        }

        @if (PuedeVer("Pasajeros"))
        {
            <a class="sb-link @(isPasajeros ? "active" : "")" asp-controller="Pasajeros" asp-action="Listar">
                <i class="bi bi-person-badge"></i><span>Pasajeros</span>
            </a>
        }

        @if (PuedeVer("Boletos"))
        {
            <a class="sb-link @(isBoletos ? "active" : "")" asp-controller="Boletos" asp-action="Listar">
                <i class="bi bi-ticket-perforated"></i><span>Boletos</span>
            </a>
        }

        @if (PuedeVer("Equipaje"))
        {
            <a class="sb-link @(isEquipaje ? "active" : "")" asp-controller="Equipaje" asp-action="Listar">
                <i class="bi bi-bag"></i><span>Equipaje</span>
            </a>
        }

        @if (PuedeVer("Servicios"))
        {
            <a class="sb-link @(isServicios ? "active" : "")" asp-controller="Servicios" asp-action="Listar">
                <i class="bi bi-gear"></i><span>Servicios</span>
            </a>
        }

        @if (PuedeVer("Reservas"))
        {
            <a class="sb-link @(isReservas ? "active" : "")" asp-controller="Reservas" asp-action="Listar">
                <i class="bi bi-calendar-check"></i><span>Reservas</span>
            </a>
        }

        @if (PuedeVer("Facturacion"))
        {
            <a class="sb-link @(isFacturacion ? "active" : "")" asp-controller="Facturacion" asp-action="Listar">
                <i class="bi bi-receipt"></i><span>Facturacion</span>
            </a>
        }

        @if (PuedeVer("Historiales"))
        {
            <a class="sb-link @(isHistoriales ? "active" : "")" asp-controller="Historiales" asp-action="Listar">
                <i class="bi bi-clock-history"></i><span>Historiales</span>
            </a>
        }

    </nav>

    <div class="sb-footer mt-auto px-3 py-3">
        <div class="dropdown">
            <a class="d-flex align-items-center text-decoration-none text-white dropdown-toggle"
               href="#" data-bs-toggle="dropdown">
                <img src="https://avatars.githubusercontent.com/u/1?v=4"
                     alt="Usuario" class="rounded-circle me-2"
                     width="32" height="32">
                <strong class="sb-user">@nombre</strong>
            </a>
            <ul class="dropdown-menu dropdown-menu-dark text-small shadow">
                <li>
                    <a class="dropdown-item"
                       asp-controller="Usuarios"
                       asp-action="Modificar"
                       asp-route-id="@idUsuario"
                       asp-route-IdUsuario="@idUsuario">
                        Configuración
                    </a>
                </li>
                <li>
                    <a class="dropdown-item"
                       asp-controller="Usuarios"
                       asp-action="Modificar"
                       asp-route-id="@idUsuario"
                       asp-route-IdUsuario="@idUsuario">
                        Perfil
                    </a>
                </li>
                <li><hr class="dropdown-divider" /></li>

                @*  Opción 1: Logout por GET *@
                <li>
                    <a class="dropdown-item" asp-controller="Account" asp-action="Logout">
                        Cerrar sesión
                    </a>
                </li>

                @*  Opción 2 (POST) 
                <li>
                    <form asp-controller="Account" asp-action="Logout" method="post" class="px-2 m-0">
                        @Html.AntiForgeryToken()
                        <button type="submit" class="dropdown-item w-100 text-start">
                            Cerrar sesión
                        </button>
                    </form>
                </li>
                *@
            </ul>
        </div>
    </div>
</aside>
